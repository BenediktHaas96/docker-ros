name: GitLab

on: [push]

jobs:

  trigger:
    name: trigger
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Trigger pipeline
        run: |
          mkdir artifacts
          curl --silent --fail --request POST --form "token=${{ secrets.DOCKER_ROS_CI_TRIGGER_GITLAB_TOKEN }}" --form "ref=main" --form "variables[DOCKER_ROS_GIT_REF]=$(git rev-parse HEAD)" "https://gitlab.ika.rwth-aachen.de/api/v4/projects/1886/trigger/pipeline" | jq -r .id > artifacts/id

  watch:
    name: watch
    runs-on: ubuntu-latest
    needs: trigger
    steps:
      - name: Wait for pipeline completion
        run: |
          PIPELINE_ID=$(cat artifacts/id)
          while true; do
            sleep 30
            PIPELINE_STATUS=$(curl --silent --header "PRIVATE-TOKEN: ${{ secrets.DOCKER_ROS_CI_READ_PIPELINE_GITLAB_TOKEN }}" "https://gitlab.ika.rwth-aachen.de/api/v4/projects/1886/pipelines/$PIPELINE_ID" | jq -r .status)
            echo "Pipeline status: $PIPELINE_STATUS (https://gitlab.ika.rwth-aachen.de/fb-fi/ops/docker-ros-ci/-/pipelines/$PIPELINE_ID)"
            if [[ $PIPELINE_STATUS == "success" ]]; then
              break
            elif [[ $PIPELINE_STATUS == "failed" ]]; then
              exit 1
            elif [[ $PIPELINE_STATUS == "canceled" ]]; then
              exit 1
            fi
          done
