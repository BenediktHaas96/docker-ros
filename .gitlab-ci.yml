stages:
  - Test

trigger:
  stage: Test
  image: badouralix/curl-jq
  script:
    - mkdir artifacts
    - curl --silent --fail --request POST --form token=$DOCKER_ROS_CI_TRIGGER_TOKEN --form ref=main --form "variables[DOCKER_ROS_GIT_REF]=$CI_COMMIT_SHA" "https://gitlab.ika.rwth-aachen.de/api/v4/projects/1886/trigger/pipeline" | jq -r .id > artifacts/id
  artifacts:
    paths: [artifacts]
    expire_in: 1h

monitor:
  stage: Test
  image: badouralix/curl-jq
  needs: [trigger]
  script:
    - |-
      while true; do
        PIPELINE_STATUS=$(curl --silent --header "PRIVATE-TOKEN: glpat-zLd3yAyqsAjQg2cZDpV_" "https://gitlab.ika.rwth-aachen.de/api/v4/projects/1886/pipelines/$(cat artifacts/id)" | jq -r .status)
        if [[ $PIPELINE_STATUS == "success" ]]; then
          break
        elif [[ $PIPELINE_STATUS == "failed" ]]; then
          exit 1
        elif [[ $PIPELINE_STATUS == "canceled" ]]; then
          exit 1
        fi
      done
